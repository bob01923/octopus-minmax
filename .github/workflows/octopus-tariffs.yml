name: Octopus MinMax Bot (IFTTT Triggered)

on:
  # Remove the unreliable cron schedule
  # schedule:
  #   - cron: '5 22,23 * * *'
  
  # Replace with IFTTT webhook trigger
  repository_dispatch:
    types: [octopus-bot-trigger]
  
  # Keep manual trigger for testing
  workflow_dispatch:

jobs:
  # Live run (triggered by IFTTT at 11 PM BST)
  ifttt-live-run:
    name: IFTTT Triggered Live Run
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch'
    steps:
      - name: Run live tariff switching bot
        run: |
          echo "ðŸ”´ IFTTT triggered live run at 11 PM BST..."
          docker run \
            --name MinMaxBot-Live \
            -e ACC_NUMBER="${{ secrets.ACC_NUMBER }}" \
            -e API_KEY="${{ secrets.API_KEY }}" \
            -e NOTIFICATION_URLS="${{ secrets.NOTIFICATION_URLS }}" \
            -e TARIFFS="agile,cosy,go" \
            -e TZ="Europe/London" \
            -e BATCH_NOTIFICATIONS=false \
            -e ONE_OFF=true \
            -e DRY_RUN=false \
            eelmafia/octopus-minmax-bot

  # Manual dry run (unchanged)
  manual-dry-run:
    name: Manual Dry Run Check
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Run dry run for cost comparison
        run: |
          echo "ðŸš€ Running manual dry run..."
          docker run \
            --name MinMaxBot-DryRun \
            -e ACC_NUMBER="${{ secrets.ACC_NUMBER }}" \
            -e API_KEY="${{ secrets.API_KEY }}" \
            -e NOTIFICATION_URLS="${{ secrets.NOTIFICATION_URLS }}" \
            -e TARIFFS="agile,cosy,go" \
            -e TZ="Europe/London" \
            -e BATCH_NOTIFICATIONS=false \
            -e ONE_OFF=true \
            -e DRY_RUN=true \
            eelmafia/octopus-minmax-bot
