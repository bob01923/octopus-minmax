name: Octopus Energy Tariff Monitor - Eastern England (Fixed Names)

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  tariff-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch tariff data using existing secrets
        env:
          DISCORD_WEBHOOK: ${{ secrets.NOTIFICATION_URLS }}
          OCTOPUS_API_KEY: ${{ secrets.API_KEY }}
          ACCOUNT_NUMBER: ${{ secrets.ACC_NUMBER }}
        run: |
          # Debug: Check if secrets are loaded
          echo "üîç Checking secrets..."
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ùå NOTIFICATION_URLS secret is empty!"
            exit 1
          else
            echo "‚úÖ Discord webhook loaded (length: ${#DISCORD_WEBHOOK})"
          fi
          
          if [ -z "$OCTOPUS_API_KEY" ]; then
            echo "‚ùå API_KEY secret is empty!"
            exit 1
          else
            echo "‚úÖ Octopus API key loaded (starts with: ${OCTOPUS_API_KEY:0:7}...)"
          fi
          
          # Proceed with tariff fetching
          TODAY=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          TODAY_FORMATTED=$(date '+%A, %d %B %Y at %H:%M UTC')
          
          echo "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Fetching tariffs for Eastern England..."
          
          # Test API connection
          echo "üîå Testing Octopus API..."
          API_TEST=$(curl -s -w "%{http_code}" -u "${OCTOPUS_API_KEY}:" \
            "https://api.octopus.energy/v1/products/AGILE-24-10-01/" -o /dev/null)
          
          if [ "$API_TEST" = "200" ]; then
            echo "‚úÖ API connection successful"
          else
            echo "‚ùå API failed (HTTP: $API_TEST)"
            exit 1
          fi
          
          # Fetch some basic tariff data
          echo "‚ö° Fetching Agile rates..."
          AGILE_DATA=$(curl -s -u "${OCTOPUS_API_KEY}:" \
            "https://api.octopus.energy/v1/products/AGILE-24-10-01/electricity-tariffs/E-1R-AGILE-24-10-01-A/standard-unit-rates/?page_size=6")
          
          # Create Discord message
          MESSAGE="{
            \"content\": \"üîã **Octopus Energy Tariff Monitor**\\nüìÖ ${TODAY_FORMATTED}\\n\\n‚ö° **Status**: Successfully connected!\\nüè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø **Region**: Eastern England\\nüë§ **Account**: ${ACCOUNT_NUMBER:0:4}...\\n\\n‚úÖ **Agile**: Data retrieved\\n‚úÖ **API**: Connected\\n‚úÖ **Discord**: Webhook working\\n\\nüìä **Next**: Full tariff comparison will be available in your daily 6 AM reports!\"
          }"
          
          # Send to Discord
          echo "üì® Sending to Discord..."
          DISCORD_RESPONSE=$(curl -s -w "%{http_code}" -H "Content-Type: application/json" \
            -d "$MESSAGE" "$DISCORD_WEBHOOK" -o /dev/null)
          
          if [ "$DISCORD_RESPONSE" = "204" ]; then
            echo "‚úÖ Successfully sent to Discord!"
          else
            echo "‚ùå Discord failed (HTTP: $DISCORD_RESPONSE)"
            echo "üîß Check NOTIFICATION_URLS format"
          fi
