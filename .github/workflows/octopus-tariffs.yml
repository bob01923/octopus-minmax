name: Octopus Energy Tariff Monitor - Eastern England (Fixed)

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  tariff-monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Eastern England tariff data
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}
        run: |
          TODAY=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          TOMORROW=$(date -u -d '+1 day' +%Y-%m-%dT%H:%M:%SZ)
          
          echo "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Fetching LATEST tariffs for Eastern England..."
          
          # Export variables for Python access
          export DISCORD_WEBHOOK="${DISCORD_WEBHOOK}"
          export OCTOPUS_API_KEY="${OCTOPUS_API_KEY}"
          
          # Fetch API data
          echo "‚ö° Fetching Agile rates..."
          AGILE_DATA=$(curl -s -u "${OCTOPUS_API_KEY}:" \
            "https://api.octopus.energy/v1/products/AGILE-24-10-01/electricity-tariffs/E-1R-AGILE-24-10-01-A/standard-unit-rates/?period_from=${TODAY}&period_to=${TOMORROW}&page_size=48")
          
          echo "üìä Fetching Tracker v2 rates..."
          TRACKER_DATA=$(curl -s -u "${OCTOPUS_API_KEY}:" \
            "https://api.octopus.energy/v1/products/TRACK-25-04-01/electricity-tariffs/E-1R-TRACK-25-04-01-A/standard-unit-rates/?page_size=1")
          
          # Send Discord notification using curl (simpler approach)
          TODAY_FORMATTED=$(date '+%A, %d %B %Y')
          
          MESSAGE="üîã **Energy Tariff Report - Eastern England**
          üìÖ ${TODAY_FORMATTED}
          
          ‚ö° **Agile Octopus** (AGILE-24-10-01):
          ‚Ä¢ Half-hourly rates update daily after 4pm
          ‚Ä¢ Capped at 100p/kWh (including VAT)
          ‚Ä¢ Perfect for flexible usage patterns
          
          üìä **Tracker v2 April 2025** (TRACK-25-04-01):
          ‚Ä¢ Daily wholesale rates following market prices
          ‚Ä¢ Capped at 100p/kWh electricity
          ‚Ä¢ Good for consistent daily usage
          
          üöó **Octopus Go** (EV Tariff):
          ‚Ä¢ Super cheap overnight rates 00:30-04:30
          ‚Ä¢ Perfect for electric vehicle charging
          
          üè† **Cosy Octopus** (Heat Pump):
          ‚Ä¢ 3 off-peak periods: 4-7am, 1-4pm, 10pm-12am
          ‚Ä¢ 51% cheaper during off-peak times
          
          üí° **Eastern England Optimization**:
          Check API for real-time rates and plan usage accordingly!
          
          _Region A (Eastern England) | Prices include VAT_"
          
          # Send to Discord using curl
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"${MESSAGE}\"}" \
               "${DISCORD_WEBHOOK}"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Successfully sent tariff update to Discord"
          else
            echo "‚ùå Failed to send to Discord"
          fi
